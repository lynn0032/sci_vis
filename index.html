<html>
<script src = 'https://d3js.org/d3.v5.min.js'></script>
<script src="https://unpkg.com/d3-simple-slider"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>

<body onload = 'init()'>
	<h1> Understanding the \(k\)-Nearest Neighbors Classification Algorithm </h1>
	<p> The \(k\)-nearest neighbor algorithm blah blah blah </p>
	<p> Given a set a labeled datapoints and a new point to classify,
		<ul>
			<li>Find the \(k\) labeled data points which are closest to the new point</li>
			<li>Those \(k\) labeled data points "vote" on which label to give the new point</li>
			<li>The new point is labeled with the most frequent label amongst the neighbors</li>
	</ul></p>
	<p> About the data breast cancer</p>
  
  <svg width=960 height=500>
	  
	  <rect x=10 y=10 width=350 height=40 style="stroke-width:1;stroke:black;fill-opacity:.1"></rect>
	  <text x=25 y=40 font-family="Verdana" font-size="20" fill="black"> Visualizing k-Nearest Neighbors </text>


	</svg>
	
<script>
	var k = '1';
	var point_selected = false;
	var m_neighbors = '0';
	var b_neighbors = '0';
	var classification = '';
	var actual_x = '0';
	var actual_y = '0';
	
	function draw_axes(){
		//code in this function is adapted from: https://www.tutorialsteacher.com/d3js/axes-in-d3
		
		var width = 480, height = 440;

		var svg = d3.select('svg');

		var x_ticks = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24];
		var xscale = d3.scaleLinear().domain([d3.min(x_ticks), d3.max(x_ticks)]).range([0, 9*width/10]);

		var y_ticks = [0, 2, 4, 6, 8, 10, 12, 14, 16, 18, 20, 22];
		var yscale = d3.scaleLinear().domain([d3.min(y_ticks), d3.max(y_ticks)]).range([9*height/10, 0]);

		var x_axis = d3.axisBottom().scale(xscale);

		var y_axis = d3.axisLeft().scale(yscale);

    		svg.append("g").attr("transform", "translate(50, 80)").call(y_axis);

		var xAxisTranslate = 9*height/10 + 80;

    		svg.append("g").attr("transform", "translate(50, " + xAxisTranslate  +")").call(x_axis);

	}
	
	function make_legend(){
		window.legend = d3.select("body").append("div").style("position", "absolute").style("visibility", "visible")
			.style("left", "500px").style("top", "650px").style("border", "solid").style("border-width", "1px")
			.style("border-radius", "5px").style("padding", "5px").style("font-family", "Verdana").style("font-size", "11");
		window.legend_circle1 = d3.select('svg').append('circle').attr("cx", "507").attr("cy", "421").attr("r", "5");
		window.legend_circle2 = d3.select('svg').append('circle').attr("cx", "507").attr("cy", "436").attr("r", "5");
		legend.html("&nbsp&nbsp&nbsp&nbsp Malignant Tumor<br>&nbsp&nbsp&nbsp&nbsp Benign Tumor");
		legend_circle1.style("fill", "orange").style("fill-opacity", ".5");
		legend_circle2.style("fill", "blue").style("fill-opacity", ".5");
	}
	
	function display_votes(){
		votes.style("visibility", "visible")
		if (m_neighbors >= b_neighbors) {classification = "Malignant";}
		else {classification = "Benign";}
		votes.html("New point: (" + String(actual_x).slice(0,5) + ", " + String(actual_y).slice(0,5) + ")"
			   + "<br> Malignant neighbors: " + String(m_neighbors) 
			   + "<br> Benign neighbors: " + String(b_neighbors) 
			   + "<br> Classification: " + classification);
	}
	
	function classification(letter){
		if (letter == "M") {return "Malignant";}
		else {return "Benign";}
	}
	
	function tooltip_text(d){
		tooltip.html("Coordinates: (" + d['pc1'].slice(0,5) + ", " + d['pc2'].slice(0,5) + ") <br> Classification: " + classification(d['diagnosis']));
	}
	
	function move_new_point(x, y){
		point_selected = true;
		new_point.attr("cx", x).attr("cy", y).style("fill-opacity", "1");
		actual_x = (parseFloat(x) - 50.0) / 18.0;
		actual_y = (parseFloat(y) - 476.0) / (-18.0);
		
		points = points.sort(function(a,b){
			return distance(parseFloat(a.pc1) + 6.0, parseFloat(a.pc2) + 8.0, actual_x, actual_y) - distance(parseFloat(b.pc1) + 6.0, parseFloat(b.pc2) + 8.0, actual_x, actual_y);
		});
		k_nearest();
		display_votes();
	}
	
	function make_background(){
		window.background = d3.select('svg').append("g").append('rect').attr("width","432").attr("height","396")
			.attr("x", "50").attr("y", "80").style("fill-opacity", "0").on("click", function(){
			var coords = d3.mouse(this);
			move_new_point(coords[0], coords[1]);
		});
	}
	
	function distance(x1, y1, x2, y2){
		let x = x2 - x1;
		let y = y2 - y1;
		return Math.sqrt(x*x + y*y);
	}
	
	function k_nearest(){
		//assume points are already sorted
		m_neighbors = '0';
		b_neighbors = '0';
		points.style("stroke", "black").style("fill-opacity", function (d,i) {
			if (i < k) {
				if (d.diagnosis == "B") {b_neighbors++;}
				else {m_neighbors++;}
				return .75;
			}
			else {return .1}
		}).style("stroke-opacity", function (d,i){
			if (i < k) {return 1;}
			else {return 0;}
		});
		
	}
	
	async function init(){
		
		draw_axes();
		make_legend();
		
		//slider
		var slider = d3.sliderHorizontal().min(1).max(569).step(1).width(300).ticks(0).displayValue(true).value(1)
			.on('onchange', function(val){ 
				k = d3.format('.1f')(val); 
				if (point_selected) {k_nearest(); display_votes();}
			});
		d3.select('svg').append('g').attr('transform', 'translate(550,80)').call(slider);
		
		make_background();
		
		//plot data points
		const data = await d3.csv("https://raw.githubusercontent.com/lynn0032/sci_vis/master/bc_data.csv");
		window.points = d3.select('svg').append("g").attr("transform", "translate(50, 80)").selectAll('circle').data(data).enter().append('circle')
			.attr("cx", function(d){return 18*(parseFloat(d.pc1)+6);})
			.attr("cy",function(d){return 396-18*(parseFloat(d.pc2)+8);})
			.style("fill", function(d){if (d.diagnosis=="B") {return "blue";} else {return "orange";}})
			.attr("r", 3).style("fill-opacity", ".5");
		
		//make new point, hidden for now
		window.new_point = d3.select('svg').append("circle").attr("cx", 0).attr("cy", 0).attr("r", "3")
			.style("fill", "black").style("fill-opacity", "0");
		
		//display votes, hidden for now
		window.votes = d3.select("body").append("div").style("position", "absolute").style("visibility", "hidden")
			.style("left", "500px").style("top", "450px").style("border", "solid").style("border-width", "1px")
			.style("border-radius", "5px").style("padding", "5px").style("font-family", "Verdana").style("font-size", "11");
		
		//tooltip
		window.tooltip = d3.select("body").append("div").attr("class", "tooltip").style("position", "absolute")
			.style("visibility", "hidden").style("background-color", "white").style("border", "solid").style("border-width", "1px")
			.style("border-radius", "5px").style("padding", "10px");
		points.on("mouseover", function(d){
			d3.select(this).style("stroke", "black").style("stroke-opacity", "1");
			tooltip_text(d);
			tooltip.style("visibility", "visible").style("left", (d3.event.pageX) + "px").style("top", (d3.event.pageY) + "px");});
		points.on("mouseout", function(){
			d3.select(this).style("stroke-opacity", "0");
			tooltip.style("visibility", "hidden");});
		
		
        
	}
	
	</script>
	

  </body>

</html>
